<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Allograft Management</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>üîê Admin Panel</h1>
      <p>Grant roles and manage the system</p>
      <nav class="nav">
        <a href="index.html" class="home">üè† Home</a>
        <a href="workflow-guide.html">üìñ Workflow Guide</a>
        <a href="doctor.html">Doctor</a>
        <a href="transplant-team.html">Transplant Team</a>
        <a href="procurement-team.html">Procurement Team</a>
        <a href="matching-organizer.html">Matching Organizer</a>
        <a href="donor-surgeon.html">Donor Surgeon</a>
        <a href="transporter.html">Transporter</a>
        <a href="transplant-surgeon.html">Transplant Surgeon</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div class="workflow-steps">
      <h3>üìã Admin Setup Guide:</h3>
      <ol>
        <li><span class="step-highlight">Important:</span> You must connect with the admin account that deployed the contract</li>
        <li><strong>Admin Account:</strong> <code>0x63b7acCBeE71A6a026A0BdC3a0734D74384eD15C</code></li>
        <li><span class="step-highlight">Setup:</span> Grant all 7 roles to your admin account (one-time setup)</li>
        <li>In production, grant specific roles to different user addresses</li>
        <li><strong>Roles:</strong> DOCTOR, TRANSPLANT_TEAM, PROCUREMENT_TEAM, MATCHING_ORGANIZER, DONOR_SURGEON, TRANSPORTER, TRANSPLANT_SURGEON</li>
      </ol>
      <div class="info-box">
        <p><strong>üí° Tip:</strong> The admin account has DEFAULT_ADMIN_ROLE which allows granting any role to any address.</p>
        <p><strong>üîç Check:</strong> Look at "Admin Status" above - it should show "‚úÖ Admin" when connected with the correct account.</p>
      </div>
    </div>

    <div class="wallet-info">
      <div>
        <strong>Connected Account:</strong> <span id="walletAddress">Not connected</span>
        <br>
        <strong>Admin Status:</strong> <span id="adminStatus">Checking...</span>
      </div>
      <button class="btn btn-primary" id="btnConnect">Connect Wallet</button>
    </div>

    <div class="grid-2">
      <div class="card">
        <h2>Grant Roles</h2>
        <div class="form-group">
          <label>Account Address</label>
          <input type="text" id="accountAddress" placeholder="0x...">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="roleSelect">
            <option value="DOCTOR">Doctor</option>
            <option value="TRANSPLANT_TEAM">Transplant Team</option>
            <option value="PROCUREMENT_TEAM">Procurement Team</option>
            <option value="MATCHING_ORGANIZER">Matching Organizer</option>
            <option value="DONOR_SURGEON">Donor Surgeon</option>
            <option value="TRANSPORTER">Transporter</option>
            <option value="TRANSPLANT_SURGEON">Transplant Surgeon</option>
          </select>
        </div>
        <button class="btn btn-success" id="btnGrantRole">Grant Role</button>
        <button class="btn btn-warning" id="btnGrantAllToCurrent">Grant All Roles to Current Account</button>
      </div>

      <div class="card">
        <h2>Check Role</h2>
        <div class="form-group">
          <label>Account Address</label>
          <input type="text" id="checkAccount" placeholder="0x...">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="checkRole">
            <option value="DOCTOR">Doctor</option>
            <option value="TRANSPLANT_TEAM">Transplant Team</option>
            <option value="PROCUREMENT_TEAM">Procurement Team</option>
            <option value="MATCHING_ORGANIZER">Matching Organizer</option>
            <option value="DONOR_SURGEON">Donor Surgeon</option>
            <option value="TRANSPORTER">Transporter</option>
            <option value="TRANSPLANT_SURGEON">Transplant Surgeon</option>
          </select>
        </div>
        <button class="btn btn-primary" id="btnCheckRole">Check Role</button>
        <div id="roleResult" style="margin-top:15px;"></div>
      </div>
    </div>

    <div class="card">
      <h2>View Waiting Lists</h2>
      <button class="btn btn-primary" id="btnViewLists">Refresh Lists</button>
      <div class="grid-2" style="margin-top:20px;">
        <div>
          <h3>Patient Waiting List</h3>
          <div id="patientList"></div>
        </div>
        <div>
          <h3>Donor Waiting List</h3>
          <div id="donorList"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>System Logs</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3@4.8.0/dist/web3.min.js"></script>
  <script src="common.js"></script>
  <script>
    // Wait for Web3 to be loaded before initializing ROLES
    let ROLES = {};
    
    function initializeRoles() {
      if (typeof Web3 === 'undefined' || typeof web3 === 'undefined') {
        console.error('Web3 not loaded yet, retrying...');
        setTimeout(initializeRoles, 100);
        return;
      }
      
      try {
        ROLES = {
          DOCTOR: web3.utils.keccak256("DOCTOR_ROLE"),
          TRANSPLANT_TEAM: web3.utils.keccak256("TRANSPLANT_TEAM_ROLE"),
          PROCUREMENT_TEAM: web3.utils.keccak256("PROCUREMENT_TEAM_ROLE"),
          MATCHING_ORGANIZER: web3.utils.keccak256("MATCHING_ORGANIZER_ROLE"),
          DONOR_SURGEON: web3.utils.keccak256("DONOR_SURGEON_ROLE"),
          TRANSPORTER: web3.utils.keccak256("TRANSPORTER_ROLE"),
          TRANSPLANT_SURGEON: web3.utils.keccak256("TRANSPLANT_SURGEON_ROLE")
        };
        console.log('Roles initialized:', ROLES);
      } catch (error) {
        console.error('Error initializing roles:', error);
      }
    }
    
    // Initialize roles immediately
    initializeRoles();

    // Check admin status
    async function checkAdminStatus() {
      const statusEl = document.getElementById('adminStatus');
      
      console.log('checkAdminStatus called - contract:', !!contract, 'currentAccount:', currentAccount);
      
      if (!contract || !currentAccount) {
        if (statusEl) statusEl.textContent = 'Not connected';
        console.log('Missing contract or currentAccount');
        return;
      }
      
      try {
        console.log('Checking hasRole for account:', currentAccount);
        // Check if current account has DEFAULT_ADMIN_ROLE (all zeros)
        const hasAdminRole = await callView('hasRole', ['0x0000000000000000000000000000000000000000000000000000000000000000', currentAccount]);
        console.log('hasRole result:', hasAdminRole);
        
        statusEl.textContent = hasAdminRole ? '‚úÖ Admin' : '‚ùå Not Admin';
        
        if (!hasAdminRole) {
          log('‚ö† Warning: Current account does not have admin privileges. You need to connect with the deployer account.', 'error');
        } else {
          log('‚úÖ Admin privileges confirmed!', 'success');
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
        statusEl.textContent = 'Error checking';
      }
    }

    document.getElementById('btnGrantRole').onclick = async () => {
      const account = getVal('accountAddress');
      const role = getVal('roleSelect');
      if (!account) return log('Please enter account address', 'error');
      
      log(`Checking if current account has admin privileges...`, 'info');
      
      // Check if current account has DEFAULT_ADMIN_ROLE
      const hasAdminRole = await callView('hasRole', ['0x0000000000000000000000000000000000000000000000000000000000000000', currentAccount]);
      if (!hasAdminRole) {
        log(`‚úó Current account does not have admin privileges!`, 'error');
        alert(`You need to connect with the admin account that deployed the contract.\n\nExpected admin account: 0x63b7acCBeE71A6a026A0BdC3a0734D74384eD15C\n\nCurrent account: ${currentAccount}`);
        return;
      }
      
      log(`‚úì Admin privileges confirmed. Granting ${role} role to ${account}...`, 'info');
      
      const result = await sendTransaction('grantRole', [ROLES[role], account]);
      
      if (result) {
        log(`‚úÖ ${role} role granted to ${account} successfully!`, 'success');
        alert(`${role} role has been granted to ${account}`);
        
        // Clear the form
        document.getElementById('accountAddress').value = '';
      }
    };

    document.getElementById('btnGrantAllToCurrent').onclick = async () => {
      if (!currentAccount) {
        log('Please connect wallet first', 'error');
        return;
      }
      
      log(`Checking admin privileges...`, 'info');
      
      // Check if current account has DEFAULT_ADMIN_ROLE
      const hasAdminRole = await callView('hasRole', ['0x0000000000000000000000000000000000000000000000000000000000000000', currentAccount]);
      if (!hasAdminRole) {
        log(`‚úó Current account does not have admin privileges!`, 'error');
        alert(`You need to connect with the admin account that deployed the contract.\n\nExpected admin account: 0x63b7acCBeE71A6a026A0BdC3a0734D74384eD15C\n\nCurrent account: ${currentAccount}`);
        return;
      }
      
      log(`Granting all roles to ${currentAccount}...`, 'info');
      
      const roles = Object.values(ROLES);
      let successCount = 0;
      
      for (const role of roles) {
        try {
          const result = await sendTransaction('grantRole', [role, currentAccount]);
          if (result) {
            successCount++;
            log(`‚úì Granted role ${Object.keys(ROLES)[roles.indexOf(role)]}`, 'success');
          }
        } catch (error) {
          log(`‚úó Failed to grant role ${Object.keys(ROLES)[roles.indexOf(role)]}: ${error.message}`, 'error');
        }
      }
      
      if (successCount === roles.length) {
        log(`üéâ All ${successCount} roles granted successfully to current account!`, 'success');
        alert(`All ${successCount} roles have been granted to your current account!\n\nYou can now use all portals.`);
      } else {
        log(`‚ö† Only ${successCount}/${roles.length} roles granted successfully`, 'warning');
      }
    };

    document.getElementById('btnViewLists').onclick = async () => {
      const lists = await callView('getWaitingLists');
      if (!lists) return;
      
      const patientList = document.getElementById('patientList');
      const donorList = document.getElementById('donorList');
      
      if (lists[0].length === 0) {
        patientList.innerHTML = '<p class="alert alert-info">No patients in waiting list</p>';
      } else {
        patientList.innerHTML = '<ul>' + lists[0].map(id => `<li>Patient ID: ${id}</li>`).join('') + '</ul>';
      }
      
      if (lists[1].length === 0) {
        donorList.innerHTML = '<p class="alert alert-info">No donors in waiting list</p>';
      } else {
        donorList.innerHTML = '<ul>' + lists[1].map(id => `<li>Donor ID: ${id}</li>`).join('') + '</ul>';
      }
      
      log('Waiting lists refreshed', 'success');
    };

    // Override the connectWallet function to add admin status check
    const originalConnectWallet = window.connectWallet;
    if (typeof originalConnectWallet === 'function') {
      window.connectWallet = async () => {
        const result = await originalConnectWallet();
        if (result !== false) {
          await checkAdminStatus();
        }
        return result;
      };
    }

    // Try to detect an already-connected account (no popup) and initialize contract + admin status
    (async function tryAutoInitialize() {
      try {
        if (typeof window.ethereum === 'undefined') {
          // MetaMask not installed
          document.getElementById('adminStatus').textContent = 'MetaMask not installed';
          return;
        }

        // Wait for Web3 to be available
        let retries = 0;
        while (typeof Web3 === 'undefined' && retries < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }

        if (typeof Web3 === 'undefined') {
          console.error('Web3 library failed to load');
          document.getElementById('adminStatus').textContent = 'Web3 not loaded';
          return;
        }

        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts && accounts.length > 0) {
          // Use the first available account without prompting
          currentAccount = accounts[0];
          console.log('Auto-detected account:', currentAccount);
          
          // Ensure web3 is initialized
          if (!web3) {
            web3 = new Web3(window.ethereum);
            console.log('Web3 initialized in auto-init');
          }
          
          // Load contract if not already loaded
          if (!contract) {
            try {
              contract = await loadContract();
              console.log('Contract loaded in auto-init:', contract.options.address);
            } catch (e) {
              console.error('Could not load contract during auto-init:', e);
              document.getElementById('adminStatus').textContent = 'Contract load failed';
              return;
            }
          }
          
          updateWalletDisplay();
          
          // Small delay to ensure contract is ready
          await new Promise(resolve => setTimeout(resolve, 200));
          
          await checkAdminStatus();
          console.log('Auto-initialization complete');
        } else {
          console.log('No accounts detected');
          document.getElementById('adminStatus').textContent = 'Not connected';
        }

        // React to account changes and refresh admin status
        if (window.ethereum && window.ethereum.on) {
          window.ethereum.on('accountsChanged', async (newAccounts) => {
            console.log('Account changed:', newAccounts);
            currentAccount = newAccounts && newAccounts.length ? newAccounts[0] : null;
            updateWalletDisplay();
            
            // Small delay before checking admin status
            await new Promise(resolve => setTimeout(resolve, 100));
            await checkAdminStatus();
          });
        }
      } catch (err) {
        console.error('Auto-initialize failed:', err);
        document.getElementById('adminStatus').textContent = 'Initialization error';
      }
    })();
  </script>
</body>
</html>
